# narrowroad-m68k

narrowroad, a kind of Forth implementation  for Motorola 68000 CPU.

narrowroadは、同人誌「Octalのほそ道2『野望編』」(C103頒布予定)の中で実装を進めている Forth処理系です。本リポジトリは Motorola 68000 用の実装です。

「Octalのほそ道」のテーマは、1970年ごろにForth処理系を開発したCharles Mooreさんのたどった道をたどるというものです。彼の論文を読み解きながら、自分の手で、未知のCPUのアセンブラで開発して、その過程を誌面に記していました。C102で第1巻「黎明編」を頒布した後、少しずつ実装を進め、C103で第2巻『野望編』を頒布することとしました。

C102で頒布した時点では、はっきり言って1 + 2 = 3を計算して3を印字するだけのものでした。C103頒布時点では、辞書作成、コロン定義、IF ... THEN ... ELSEまで実装しました。本リポジトリでは実装を扱っています。

## 本リポジトリの内容

同人誌に収録したソースコードを入れています。ビルド方法は`make`一発です。ただし、`binutils`の68000バージョンが必要です。主要なソースコードは、`codes.s`, `base.dict`, `forth.f`の3つです。

その他のソースコード`*.s`は、開発過程で作成したもので、おまけで付けてあります。

## ビルド方法

Linux環境で、`git clone`してローカルにリポジトリを用意して下さい。

```
$ git clone https://github.com/tendai22/narrowroad-m68k
```

そのあと、`narrowroad-m68k`にcdします。

```
$ cd narrowroad-m68k
```

まず、タグ`v200`をチェックアウトしてください。

```
$ git checkout v200
```

```
$ make
```
によりバイナリファイル`a.out`が生成されたのちに、アップロード形式`narrowroad.X`, `forth.X`が生成されます。これらのファイルを、私が作成したSBC(Single Board Computer) [EMU68kplus](https://github.com/tendai22/emu68kplus)にアップロードして`...`(ターゲットプログラム起動)コマンドをたたくとForth処理系が起動します。

プログラムの実行は、emu68kplusにシリアルポート経由でアップロードすることで行います。emu68kplusが起動すると、シリアル入力からアップロードされたファイルをRAM上に展開する簡易モニタが実行されているので、それにめがけて(例えばTeratermのテキストアップロード機能を用いて)`narrowroad.X`, `forth.X`をアップロードします。

## SBCエミュレータ

SBCエミュレータ [`Musashi`改](https://github.com/tendai22/Musashi) を用いると、ハードウェアなしでLinux上で外部インタプリタを試すことができます。この中の`example/m68kcpu.c`の命令実行ループの中に仕込みを入れて、ブレークポイントとシングルステップ機能を入れて、narrowroadのアセンブラプログラムを開発していました。

`Musashi`改をcloneしmakeすると、コマンド`sim`が生成されます。この引数に`narrowroad.X forth.X`を指定するとプログラム実行を開始します。`Musashi`リポジトリで得られた`sim`コマンドを本リポジトリにコピーして、

```
$ ./sim narrowroad.X forth.X
```
と実行すればよいです。

## 現時点の到達点: 外部インタプリタ`narrowroad.s`

* 内部インタプリタ、外部インタプリタは実装済、動作する。  
  外部インタプリタはワード実行の都度スタックトレースが印字され、遅い。
* 辞書ファイル`base.dict`にはいくつかのワードが定義されている。コロン定義、`IF ... ELSE ... THEN`までは動作する。
* もちろん、エディタ、HDDサポートも一切ありません。
* スタックトップ印字`.`にバグあり: `100 .`の出力が`1`になる。タグ`v100`にはこの不具合がありましたが、`v200`では修正・解決済です。

